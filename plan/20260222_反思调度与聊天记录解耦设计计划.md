# 反思调度与聊天记录解耦设计计划

## 1. 背景与问题
- 当前反思链路将 `recall_query`（检索词）作为“历史对话”输入，语义上不正确。
- 反思触发过于频繁（几乎每轮触发），在群聊/高频场景会产生明显 token 浪费。
- 主线程是一次性事件处理，无法在主线程内可靠完成“静默超时”触发。

## 2. 目标
- 检索与反思彻底解耦：
  - 检索继续使用 `recall_query`。
  - 反思必须使用真实聊天记录（`chat_records`）。
- 引入会话级调度：
  - 达到数量阈值时即时触发反思。
  - 静默超时时由后台全局 tick 触发反思。
- 支持多会话并发，不阻塞主对话流程。

## 3. 非目标
- 本阶段不改检索策略（BM25/向量/重排逻辑不变）。
- 本阶段不引入数据库持久化会话缓冲（先以内存状态运行）。
- 本阶段不新增复杂 UI 配置项（先用代码默认值）。

## 4. 总体方案

### 4.1 调度模型
- 采用“**全局 tick + 会话状态机**”：
  - 新消息进入时：更新会话状态并检查数量阈值。
  - 后台 tick 周期扫描：检查静默阈值并触发。
- 使用会话锁与 `processing` 标记，保证同会话触发幂等，避免重复反思。

### 4.2 会话状态
- 每个 `session_id` 维护：
  - `pending_turns`
  - `last_activity_at`
  - `records`
  - `latest_event_data`
  - `latest_response_data`
  - `processing`

### 4.3 反思输入
- 反思提示词的 `historical_query` 字段改为“历史聊天文本”：
  - 优先使用会话缓冲产出的聊天文本。
  - 无缓冲时才降级到旧 `query`。

## 5. 双分支聊天记录拼装规则

### 5.1 原生消息分支
- 每次事件默认只含用户最新发言。
- 插件在同轮补齐助理回复，构造增量：
  - `user -> assistant`
- 多轮合并后形成时间顺序链路：
  - `user, assistant, user, assistant, ...`

### 5.2 天使之心分支
- 输入源：`chat_records`。
- 组装规则：
  - 取 `is_processed=true` 的已处理历史；
  - 追加“最新一条 `is_processed=false` 且 `role=user`”；
  - 对合并结果按 `(role, sender_id, timestamp, content)` 去重；
  - 按 `timestamp` 升序排序。

## 6. 触发条件
- 数量触发：`pending_turns >= reflection_turn_threshold`
- 静默触发：`now - last_activity_at >= reflection_idle_seconds`
- 推荐默认：
  - `reflection_turn_threshold = 6`
  - `reflection_idle_seconds = 600`
  - `reflection_tick_seconds = 600`

## 7. 关键改动文件
- `core/deepmind.py`
  - 新增会话反思调度状态与全局 tick。
  - 新增双分支聊天记录构建、去重、排序、缓冲与触发逻辑。
  - 反思执行入口支持 `historical_chat_text_override`。
- `core/services/retrieval_service.py`
  - `parse_memory_context` 增加 `raw_chat_records` 字段透传。

## 8. 风险与应对
- 风险1：内存状态在进程重启后丢失。
  - 应对：本阶段接受；后续可落库。
- 风险2：高并发会话下重复触发。
  - 应对：`processing` 标记 + 会话锁。
- 风险3：上游 `chat_records` 异常格式。
  - 应对：严格类型判断，失败降级到原生分支。

## 9. 验收清单
- 检索仍使用 `recall_query`，反思不再把其当聊天记录。
- 同会话达到阈值可即时触发反思。
- 无新消息情况下，静默超时可由 tick 触发反思。
- 天使之心分支反思输入含“已处理历史 + 最新未处理用户消息”。
- 原生分支反思输入可形成 `user/assistant` 顺序链路。

## 10. 回滚策略
- 回滚至“每轮直接反思”的旧入口：
  - 在 `async_analyze_and_update_memory` 中直接调用原 `submit_async_analysis_task`；
  - 移除会话状态和 tick 任务逻辑即可快速恢复。

