# 向量开启回灌计划（应急实现追认版）

## 1. 目标

- 当 `enable_simple_memory=false`（向量模式）启动时：
  - 对比 `simple_memory.db` 与当前向量库的记忆 `judgment`；
  - 将向量库缺失的记忆从 simple 库迁移到向量库；
  - 迁移写入走现有 `cognitive_service.remember(...)`，确保重新向量化。

## 2. 触发时机

- 初始化完成后的后台任务中执行一次（不阻塞启动主流程）。
- 执行顺序：
  1. `simple -> vector` 回灌同步
  2. 初始化后触发一次睡眠（已有流程）

## 3. 数据与规则

- 对比键：`judgment`（`strip()` 后比较）。
- 仅迁移“simple 有、vector 无”的差集。
- 保留字段：
  - `memory_type`（中文/英文值映射到 handler key）
  - `judgment`
  - `reasoning`
  - `tags`
  - `strength`
  - `is_active`
  - `memory_scope`

## 4. 实现拆分

### 4.1 Simple 导出能力

- 文件：`llm_memory/components/memory_sql_manager.py`
- 新增：
  - `list_all_memories_for_vector_sync()`
- 用途：
  - 导出 simple 库全量记录（含 tags）供回灌服务处理。

### 4.2 回灌服务

- 文件：`core/services/simple_to_vector_sync_service.py`
- 新增服务：
  - `sync_missing_memories(cognitive_service, memory_sql_manager, provider_id)`
- 逻辑：
  - 读取 vector 全量 metadata（提取 judgment 集合）；
  - 读取 simple 全量记录；
  - 计算缺失差集并逐条 `remember` 回灌向量库。

### 4.3 初始化接入

- 文件：`core/background_initializer.py`
- 在初始化后的后台任务中：
  - 向量模式执行 `simple_to_vector_sync`；
  - 完成后继续已有 `trigger_sleep_after_init` 链路。

## 5. 日志与可观测

- 回灌开始：
  - `[simple_to_vector_sync] start provider=<id>`
- 回灌完成：
  - `[simple_to_vector_sync] done sql_total=<n> vector_total=<n> missing=<n> migrated=<n> failed=<n> cost_ms=<n>`
- 单条失败：
  - `[simple_to_vector_sync] migrate_failed judgment=<...> error=<...>`

## 6. 验收标准

1. 向量模式启动时出现 `simple_to_vector_sync start/done` 日志。
2. 当 simple 库存在而向量库缺失时，`missing > 0` 且 `migrated > 0`。
3. 回灌后可在向量检索中命中新迁移记忆。
4. 失败不阻塞初始化主流程。

## 7. 当前实现状态（追认）

- [x] 4.1 已实现
- [x] 4.2 已实现
- [x] 4.3 已接入
- [x] 关键文件 compile 检查通过

