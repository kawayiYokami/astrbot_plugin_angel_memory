# 笔记 tags 索引替代全量向量化计划（已落地归档版）

## 1. 最终结论

已完成升级：笔记链路已切换为“中央 SQL 真相源 + 向量轻量缓存”。

## 2. 已实现目标

1. 笔记权威索引落中央库（provider 无关）。
2. 笔记索引仅基于 tags（路径层级 + Markdown H1-H6）。
3. 向量层仅存轻量索引（`source_id + tags_text_embedding`），不存正文业务字段。
4. `note_recall` 改为 `note_short_id + 行范围` 读取正文（实时读取文件）。
5. Simple 模式与向量模式都可检索笔记。
6. 检索结果只返回路径/标题/tags，不直接注入正文。

## 3. 非目标（保持不做）

1. 不做正文语义向量召回。
2. 不做复杂 NLP 标签抽取。
3. 不保留旧 `NoteData + related_block_ids` 扩展逻辑。

## 4. 已落地数据结构

### 4.1 中央 SQL（真相源）

中央笔记索引表：`note_index_records`

字段：

1. `source_id` TEXT PRIMARY KEY（项目生成唯一信源ID）
2. `file_id` TEXT（文件ID）
3. `source_file_path` TEXT（相对路径）
4. `heading_h1` TEXT
5. `heading_h2` TEXT
6. `heading_h3` TEXT
7. `heading_h4` TEXT
8. `heading_h5` TEXT
9. `heading_h6` TEXT
10. `updated_at` REAL
11. `total_lines` INTEGER
12. `note_short_id` INTEGER UNIQUE（从 0 递增，删除不复用）

关系表：

1. 复用 `global_tags`
2. 复用 `note_tag_rel(source_id, tag_id)`（已存在）

约束：

1. `source_id` 全局唯一且由项目生成。
2. `tag_name -> tag_id` 全局唯一（与记忆共享）。

### 4.2 向量缓存（Chroma）

集合：`notes_index`（新）

写入规则：

1. `id = source_id`
2. `document = tags_joined_text`
3. `metadata = {"source_id": source_id}`（仅排障冗余）

说明：

1. 向量层不存正文与业务主字段。
2. 命中后必须回 SQL 取路径/标题/tags。

## 5. tags 生成规则（已实现）

来源：

1. 路径层级 tag（每一级都要）：例如 `notes/family/travel/plan.md` -> `notes`,`family`,`travel`,`plan.md`
2. Markdown 标题 tag：H1-H6

文件类型规则：

1. Markdown：路径层级 + H1-H6
2. 非 Markdown：仅路径层级

规范化：

1. 去首尾空白
2. 连续空白折叠
3. 去重

## 6. 检索规则（已实现）

### 6.1 向量模式

1. 用查询文本在 `notes_index` 做向量召回拿 `source_id`
2. 回 SQL 取 `source_file_path + headings + tags`
3. 返回候选结果（不含正文）

### 6.2 Simple 模式

1. 不走向量，直接全局 tags 命中（同记忆策略）
2. 按命中数与时间排序
3. 返回候选结果（不含正文）

## 7. note_recall 工具（最终协议）

入参：

1. `note_short_id`（必填）
2. `start_line`（可选）
3. `end_line`（可选）
4. `token_budget`（可选）

行为：

1. 按短 ID 定位索引记录后，实时读取源文件并按行裁剪。
2. 返回 `total_lines/actual_start_line/actual_end_line/content`。
3. 越界自动裁剪；`start_line > end_line` 报错。

## 8. 组件与调用链（已落地）

1. `ComponentFactory`：simple/vector 均创建 `note_service + file_monitor`（不再 simple 禁用笔记）。
2. `DeepMindRetrievalService`：simple 模式不再跳过笔记检索。
3. `NoteService`：写中央 SQL；扫描阶段不做笔记向量写入。
4. `expand_note_context`：已切到短 ID + 行范围读取。

## 9. 睡眠维护（已落地）

笔记任务：`notes_vector_sync`（仅向量模式）

1. provider 变化：全量重建 `notes_index`
2. provider 未变化：按 SQL 名单做增量同步（新增补写、失效删除）
3. 数据源：中央 SQL `note_index_records`

不做：

1. 向量->SQL 回灌（SQL 已是真相源）

## 10. 当前状态与迁移

当前按“扫描 raw -> 生成中央索引 -> 睡眠向量同步”运行。

## 11. 调试与验收

### 11.1 DebugTool 新增页

1. 笔记中央索引浏览（SQL）
2. `notes_index` 向量浏览
3. `note_short_id + 行范围` note_recall 模拟调用

### 11.2 验收标准

1. 代码中不存在“笔记正文全量向量化写入”路径。
2. Simple 模式可检索笔记并可调用 note_recall 读取正文。
3. 向量模式笔记召回结果仅含路径/标题/tags，不含正文。
4. note_recall 支持短 ID + 行范围读取。
5. `notes_index` 可由中央 SQL 重建。

## 12. 归档说明

该计划已按当前代码实现完成，后续若调整仅在新计划中迭代。
