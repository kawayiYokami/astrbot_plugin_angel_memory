# 根除关联字段计划（associations 退役）

## 1. 目标

- 完全移除废弃字段 `associations` 及其相关检测、计算、写入、清理逻辑。
- 保证运行时不再出现“关联字段检测/处理”的代码路径与日志。
- 保持现有记忆读写、scope 过滤和召回行为不被回归影响。

## 2. 范围

- 模型层：移除 `BaseMemory` 中的 `associations` 字段定义。
- 序列化层：移除 `to_dict()/from_dict()` 对 `associations` 的读写。
- 服务层：移除任何“建立关联/更新关联/清理弱关联”的逻辑和调用。
- 存储层：移除向 metadata 写入 `associations` 的行为。
- 向量存储层：移除 `vector_store.delete_memories()` 中与 `exclude_associations` 相关的参数与分支。
- 文档层：清理 `AGENTS.md`、`README.md` 中对 `association_manager.py` 的引用。
- 日志层：移除关联相关日志与告警文案。

## 3. 兼容策略（最小化）

- 反序列化兼容：历史数据若包含 `associations`，读取时忽略，不抛错。
- 不做历史数据清洗任务：不新增迁移，不阻塞启动。
- 只确保“新写入不再包含该字段，运行时不再依赖该字段”。
- 实现方式（明确化）：
  - `from_dict()` 显式 `data.get("associations", None)` 但不传入构造函数，确保旧字段被忽略。
  - 若模型为 Pydantic/dataclass，需配置 `extra='ignore'` 或在实例化前剥离未知键。
  - 增加单测：加载含 `associations` 的序列化记录，不抛异常，且结果对象不包含 associations 业务字段。

## 4. 实施步骤

1. 删除字段定义与类型引用  
- 删除模型定义中的 `associations` 字段。  
- 删除相关类型注解、默认值、构造参数。

2. 删除检测与计算路径  
- 删除 `AssociationManager` 的实例化与调用链。  
- 重构 `process_feedback()`，删除所有关联计算分支，仅保留：  
  - 强化有用回忆（`reinforce_memories`）  
  - 批量创建新记忆（handler 创建）  
  - 合并重复记忆（`merge_memories`）  
- 删除清理流程里“关联衰减/弱关联清理”的步骤。

3. 删除存储写入点  
- 删除 metadata 中 `associations` 的写入。  
- 删除 update/merge 里对 `associations` 的合并逻辑。
- 删除 `vector_store.delete_memories()` 中 `exclude_associations` 参数与相关过滤代码。

4. 构造签名与调用链同步  
- `MemoryManager.__init__` 删除 `association_manager` 参数。  
- `cognitive_service.py` 中 `MemoryManager(...)` 的构造调用同步改签名。  
- 校验其余调用点无残留旧签名。

4.1 `vector_store.delete_memories()` 影响分析（新增）
- 已移除参数：`exclude_associations`。
- 要求：全量检索调用点并同步改签名，不再传递 `exclude_associations`。
- 覆盖范围：调用方、封装层、测试、集成路径（包括脚本与调试工具）。
- 检索命令示例：
  - `rg --line-number "delete_memories\\(|exclude_associations" -g "*.py"`
- 行为变化：删除逻辑不再包含“按关联保护跳过删除”的分支，按 where 条件直接删除命中记录。
- 回退策略：若上线后发现依赖旧行为，临时在调用侧收窄 `where_filter`，并记录后续替代方案评审项。

5. 日志清理  
- 删除所有“关联字段检测”“关联网络更新”等日志。  
- 不新增“功能已退役”常驻启动日志，避免长期噪音。

6. 文档清理  
- 从 `README.md` 目录结构中移除 `association_manager.py`。  
- 清理 `AGENTS.md` 中与关联模块相关的过期描述。  

## 5. 验收标准

- 全项目不再存在 `associations` 字段写入与业务依赖。
- 全项目不再存在关联网络计算路径。
- 历史记录包含 `associations` 时，读取不报错。
- 启动和主流程不出现关联相关日志。
- remember/recall/feedback 主链路正常。

## 6. 回归清单（最小）

1. 新增记忆后检查落库 metadata，不含 `associations`。  
2. 反馈链路分支回归：  
  - `useful_memory_ids` 非空  
  - `new_memories` 非空  
  - `merge_groups` 非空  
  三个分支均可运行且无关联计算日志。  
3. 单测/实测 `consolidate_memories()`，确认移除 `cleanup_weak_associations()` 后流程正常。  
4. 召回主流程可正常返回结果。  
5. 读取一条含历史 `associations` 的旧记录，不报错。  
6. 新增反序列化兼容单测：`from_dict()` 读取包含 `associations` 的字典，断言无异常且对象无关联字段。  
7. 在实现步骤与回归清单中显式引用 `from_dict()` 与对应模型类，确保兼容目标可追踪。  

## 7. 风险与对策

- 风险：有隐藏调用依赖关联字段。  
- 对策：删除前先全局检索引用，删除后跑一次最小链路自测。  

- 风险：旧数据解析路径未兼容导致报错。  
- 对策：统一在反序列化入口忽略未知字段。  
