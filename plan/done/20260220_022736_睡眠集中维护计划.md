# 睡眠集中维护计划

## 1. 目标

- 将维护逻辑统一收口到睡眠流程，初始化仅触发一次睡眠。
- 不做任务分类框架，任务按固定顺序执行一次；是否执行由任务内部读取状态自行判断。

## 2. 状态文件（极简）

- 文件：`index/maintenance_state.json`
- 字段：
  - `last_updated_at`
  - `memory_scope_migration_done`（bool）
  - `deprecated_field_cleanup_done`（bool）
  - `simple_to_vector_sync_last_provider`（string）
  - `backup_last_sleep_at`（number）
  - `cleanup_last_sleep_at`（number）

规则：
- `memory_scope_migration_done=true` 后不再执行该任务。
- `deprecated_field_cleanup_done=true` 后不再执行该任务。
- `cleanup_last_sleep_at` 对应“本次睡眠的记忆清理（consolidate）完成时间”，每次清理成功都更新。
- `backup_last_sleep_at` 对应“本次睡眠的向量->simple 备份完成时间”，每次备份成功都更新。
- `simple_to_vector_sync` 判定按“模式+供应商”语义：
  - 向量模式下比较目标值：当前 `provider_id`。
  - simple 模式下写入标记值：`"simple"`。
  - 当目标值与 `simple_to_vector_sync_last_provider` 不同时，在向量模式执行回灌；成功后更新该字段。
  - 这样可覆盖场景：`vector(A) -> simple -> vector(A)`（会触发回灌）。

## 3. 架构

### 3.1 维护调度器

- 新增：`core/services/sleep_maintenance_service.py`
- 职责：
  - 读取/写入 `maintenance_state.json`
  - 按顺序调度任务
  - 统一异常隔离与日志

### 3.2 任务接口

每个任务提供：
- `task_key: str`
- `async run(ctx, state: dict) -> dict`

约定：
- 任务内部自行判断是否执行，并返回更新后的 `state`。

`MaintenanceContext` 包含：
- `plugin_context`
- `cognitive_service`（可空）
- `memory_sql_manager`（可空）
- `deepmind`（可空）
- `enable_simple_memory: bool`
- `provider_id: str`
- `logger`

### 3.3 接入任务

- `simple_to_vector_sync`
- `memory_scope_migration`
- `deprecated_field_cleanup`
- `vector_to_simple_backup`

## 4. 调用链改造

### 4.1 睡眠服务

- 文件：`core/services/sleep_service.py`
- 改造点：
  - 保留 `consolidate_memories()` 作为睡眠核心动作；
  - 清理成功后更新 `cleanup_last_sleep_at`；
  - 再调用 `SleepMaintenanceService.run_pipeline(...)`。

### 4.2 初始化器

- 文件：`core/background_initializer.py`
- 改造点：
  - 初始化完成后仅触发一次睡眠；
  - 删除初始化阶段独立维护逻辑入口。

## 5. 执行顺序（睡眠内）

固定顺序：
1. `simple_to_vector_sync`（任务内部按状态判断）
2. 记忆清理 `consolidate`
3. `memory_scope_migration`
4. `deprecated_field_cleanup`
5. `vector_to_simple_backup`
6. 输出本次维护汇总日志

顺序说明：
- 回灌前置，保证回灌数据能参与本轮清理。
- 备份后置，保证 simple 看到的是本轮维护后的最终态。

## 6. 日志规范

- 启动：`[sleep_maintenance] start`
- 单任务：`[sleep_maintenance] task=<key> status=<success|failed|skipped> detail=<...>`
- 汇总：`[sleep_maintenance] done success=<n> failed=<n> skipped=<n> cost_ms=<n>`

## 7. 验收

1. 初始化后触发一次睡眠，维护管线完整执行。
2. `memory_scope_migration_done`、`deprecated_field_cleanup_done` 首次成功后不再重复执行。
3. `vector(A) -> simple -> vector(A)` 返回向量模式时会触发回灌。
4. `cleanup_last_sleep_at` 与 `backup_last_sleep_at` 正确更新。
5. 任一任务失败不阻塞睡眠主流程。

## 8. 风险与对策

- 风险：任务重复执行导致性能抖动  
  对策：使用极简状态位（done/provider/last_sleep_at）判重。

- 风险：维护任务异常影响主链  
  对策：任务级 try/except，失败仅记录。

- 风险：入口分叉导致行为不一致  
  对策：维护统一入口为睡眠，初始化仅触发一次睡眠。

