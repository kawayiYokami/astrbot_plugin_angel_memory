# 重启 FTS5 混合检索计划（按最新实现重写）

## 1. 当前状态

本计划对应实现已落地，当前检索基线为：

1. 旧“标签子串匹配”主链路已移除。
2. Simple 记忆/笔记检索已切换为 FTS5 路径。
3. 采用 `jieba` 预分词 + 空格入库，FTS5 使用 `unicode61`。
4. 记忆与笔记为两套独立索引（同库分表）。

## 2. 已实现架构

### 2.1 索引模型

1. `memory_fts(item_id, tags, judgment)`  
   - 权重：`bm25(memory_fts, 2.0, 1.0)`，满足 `tags > judgment`。
2. `note_fts(item_id, tags)`  
   - 笔记仅检索 tags，不索引正文。

### 2.2 分词策略

1. 写入：Python 侧 `jieba` 分词，空格拼接后写入 FTS5。
2. 查询：同一分词函数处理查询词，再执行 `MATCH`。
3. 支持分词模式：`jieba_cut` / `jieba_cut_for_search`。

### 2.3 统一融合路径

1. FTS 候选按 rank 归一化（0~1）。
2. 融合公式：`final = fts_weight * fts_score + vector_weight * vector_score`。
   - 当前默认权重：
     - 记忆：`fts_weight=0.7`，`vector_weight=0.3`
     - 笔记：`fts_weight=0.85`，`vector_weight=0.15`
   - 两组权重均满足 `fts_weight + vector_weight = 1.0`，当前为代码默认值（可配置化为后续优化项）。
3. 当前 Simple 链路 `vector_scores` 未接入，使用默认向量分：
   - 记忆：`0.5`
   - 笔记：`0.6`
4. 阈值：
   - 记忆：`0.5`
   - 笔记：`0.6`

### 2.4 写入同步

1. 记忆新增/更新：增量 upsert 到 `memory_fts`。
2. 笔记新增/更新：增量 upsert 到 `note_fts`。
3. 记忆合并/清理等批量变更：触发 FTS 全量重建兜底一致性。
4. 笔记按文件删除：同步删除对应 `note_fts` 项。

### 2.5 启动与可观测

1. 启动阶段主动预构建 FTS，避免首次查询冷启动。
2. 索引构建后输出日志（前缀 `[FTS5重建]`）：
   - `memory_fts` 行数
   - `note_fts` 行数
   - DB 文件大小（B/MB）

## 3. 当前行为说明（与旧计划差异）

1. 无 FTS 开关：FTS5 为默认主路径，不再通过开关切换。
2. 无“标签命中分”重复计算：旧关键词子串命中逻辑已从主检索路径移除。
3. 向量分数在 Simple 链路尚未实接入：当前为默认分占位，后续由向量链路补齐真实分数输入。

## 4. 风险与约束

1. scope 过滤在 FTS 候选后执行（Python 侧），已通过过采样缓解候选不足风险。
2. 大规模数据下首次预构建会增加启动耗时（已前置，避免首查抖动）。
3. `jieba` 首次加载存在词典初始化耗时。
4. 固定占位向量分风险（`vector_scores` 缺失时记忆=0.5、笔记=0.6）：
   - 当真实语义相关性与占位值偏离较大时，融合分会产生系统性偏差，可能降低精度或召回。
   - 记忆侧可能出现误检：FTS 命中一般但语义本应较弱的条目被占位分抬高后进入 top-K。
   - 笔记侧可能出现漏检：语义强相关但关键词稀疏的条目在占位分下竞争力不足。
   - 不同场景（短查询/口语化查询/同义改写）对该偏差敏感度不同，需持续观测并调参。
5. 生产监控建议（用于占位分与权重优化闭环）：
   - 检索精度/召回率（离线标注集与线上抽检）。
   - top-K 命中率（如 top-1/top-3/top-5）。
   - 平均向量得分分布与分位数（P50/P90/P99），对比占位分区间。
   - 融合分分布漂移告警（如 7 天滑窗偏移阈值）。
   - 回归告警阈值建议：top-K 命中率下降超过 5% 或精度下降超过 3% 触发告警。
   - 告警后流程：先复核 `vector_scores` 来源可用性，再调整占位分与权重并进行 A/B 或回放验证。

## 5. 收口状态

1. 向量模式主链路已接入真实 `vector_scores`（记忆与笔记）。
2. FTS 与 SQL 一致性巡检（行数/抽样 ID）与自动修复已实现并接入睡眠维护任务。
3. 批量场景已改为增量同步优先，保留全量重建作为不一致修复兜底机制。
4. 仍使用占位分的场景为“未提供向量分或候选缺失向量分”时的降级路径，属于容错设计，不影响主链路真实向量融合。

## 6. 验收口径

1. 记忆检索满足 `tags > judgment`，并保持 `memory_scope` 过滤正确。
2. 笔记检索仅返回路径/标题/tags，正文仍通过 `note_recall(note_short_id, 行范围)` 读取。
3. 日志可看到 `[FTS5重建]` 的体积与行数信息。
4. 生产环境测试通过后，方可归档到 `plan/done/`。
