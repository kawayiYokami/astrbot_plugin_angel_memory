# 向量记忆备份到简单库计划

## 1. 目标

- 在**向量模式**下，将当前供应商的记忆定期备份到 `simple_memory.db`。
- 触发时机：
  - 初始化完成后，执行一次睡眠
  - 后续仍按既有睡眠机制执行
- 备份去重规则：按 `judgment` 去重，仅保留**时间最新**的一条。

## 2. 范围与边界

- 仅新增“备份链路”，不改变当前主检索链路。
- 仅处理当前供应商可见的向量记忆（不做跨供应商聚合）。
- 不做反向同步（SQL -> 向量）；
- 不改用户工具调用语义；
- 不改现有 scope 规则。

## 3. 数据规则

- 去重键：`judgment`（去首尾空格后比较）。
- 最新判定：使用 `created_at`（Chroma 现有记忆元数据稳定可用字段）。
- 保留字段：
  - `memory_type`
  - `judgment`
  - `reasoning`
  - `tags`
  - `strength`
  - `is_active`
  - `memory_scope`
  - `created_at`

## 4. 实现设计

### 4.1 新增备份服务

- 新增：`core/services/simple_memory_backup_service.py`
- 职责：
  - 从 `cognitive_service.main_collection` 全量读取记忆元数据（`collection.get(include=['metadatas'])`）；
  - 内存去重（按 judgment 保留最新）；
  - 写入 `MemorySqlManager`（新增批量 upsert 接口）；
  - 输出统计日志（扫描数、去重后数、写入数、失败数、耗时）。

### 4.1.1 MemorySqlManager 组件来源（向量模式）

- 文件：`core/component_factory.py`
- 向量模式下也创建并注册 `MemorySqlManager`（组件名：`memory_sql_manager`），供备份服务复用。
- `enable_simple_memory=true` 与 `enable_simple_memory=false` 两种模式都保证可从组件容器拿到该实例。

### 4.2 扩展 MemorySqlManager

- 文件：`llm_memory/components/memory_sql_manager.py`
- 新增能力：
  - `upsert_memories_by_judgment(memories: List[dict])`
  - 内部逻辑：按 `judgment` 查询已有记录，若备份记录更新则覆盖字段和标签关系。
- 索引建议：
  - `CREATE INDEX IF NOT EXISTS idx_memory_judgment ON memory_records(judgment);`

> 注：先不改成 judgment 唯一约束，避免影响现有非备份写入场景。

### 4.3 初始化触发（改为触发一次睡眠）

- 文件：`core/background_initializer.py`
- 在组件就绪后，若存在 `cognitive_service.main_collection`：
  - 不再直接执行备份；
  - 主动触发一次睡眠流程（异步任务，异常隔离）；
  - 调用方明确为 `background_initializer`（调用 `deepmind.check_and_sleep_if_needed(...)` 或 `deepmind._sleep()`）；
  - 由睡眠流程内部统一触发备份。

### 4.4 睡眠触发

- 文件：`core/services/sleep_service.py`
- 在 `consolidate_memories()` 成功后触发一次备份：
  - 仅在向量运行时可用时执行；
  - 失败只记日志，不影响睡眠主流程返回。

## 5. 运行约束

- Simple 模式（`enable_simple_memory=true`）下：
  - 不执行“向量 -> SQL 备份”（因为无向量主集合）。
- Vector 模式下：
  - 初始化阶段通过“触发一次睡眠”进入统一备份入口；
  - 后续按睡眠周期触发，允许重复执行（幂等 upsert）。

## 6. 日志与可观测

- 初始化触发睡眠：
  - `[simple_backup] trigger_sleep_after_init provider=<id>`
- 睡眠备份：
  - `[simple_backup] start source=sleep provider=<id>`
- 完成日志：
  - `[simple_backup] done scanned=<n> deduped=<n> upserted=<n> failed=<n> cost_ms=<n>`
- 失败日志：
  - `[simple_backup] failed source=<...> error=<...>`

## 7. 验收标准

1. 向量模式启动后，初始化触发一次睡眠，`simple_memory.db` 出现当前供应商记忆快照。
2. 睡眠执行后，再次备份成功，且同 judgment 仅保留最新记录。
3. 备份失败不会导致插件初始化失败，也不会导致睡眠流程失败。
4. Simple 模式下不会误触发向量备份任务。

## 8. 最小回归清单

1. 向量模式：
  - 人工写入两条同 `judgment` 不同时间记忆；
  - 初始化后自动触发一次睡眠并备份，SQL 中仅最新一条保留。
2. 向量模式：
  - 执行一次睡眠；
  - 观察备份日志与 SQL 结果一致。
3. Simple 模式：
  - 启动日志确认未执行向量备份。
