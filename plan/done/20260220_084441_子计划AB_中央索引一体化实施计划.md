# 子计划 AB：中央索引一体化实施计划（已落地归档版）

## 1. 已实现目标

1. 记忆与笔记统一使用中央 SQL 索引库作为唯一真相源。  
2. 全局 tags 管理器统一 `tag_name -> tag_id` 命名空间。  
3. 向量库降级为加速层，仅存 `source_id + vector_text + embedding`。  
4. 已移除旧兼容链路（私有 tags 命名空间、向量 metadata 业务依赖）。

## 2. 最终数据结构（已落地）

### 2.1 中央 SQL（权威）

1. `memory_records(id, memory_type, judgment, reasoning, strength, is_active, memory_scope, created_at, updated_at)`  
2. `note_index_records(source_id, note_short_id, file_id, source_file_path, heading_h1~h6, total_lines, updated_at)`  
3. `global_tags(tag_id, tag_name, created_at, updated_at)`（`tag_name` UNIQUE）  
4. `memory_tag_rel(memory_id, tag_id)`（UNIQUE(memory_id, tag_id)）  
5. `note_tag_rel(source_id, tag_id)`（UNIQUE(source_id, tag_id)）

### 2.2 向量层（缓存）

1. `memory_index`：`id=memory_id`，`document=vector_text`，`embedding`  
2. `notes_index`：`id=source_id`，`document=vector_text`，`embedding`  
3. 不再存业务 metadata（judgment/reasoning/tags/scope/strength 等）。

## 3. 统一运行流程（最终）

### 3.1 写入

1. 业务先写中央 SQL（ID 必须本项目生成）。  
2. tags 全部经 `GlobalTagManager` 映射为 `tag_id` 后写关系表。  
3. 记忆：睡眠前维护执行向量库同步；笔记：睡眠后维护执行向量库同步（provider 切换全量、未切换增量）。

### 3.2 检索

1. 向量模式：向量召回 `id` 列表 -> SQL 回查全量业务数据。  
2. Simple 模式：直接 SQL + 全局 tags 命中检索，不依赖向量。  
3. 笔记正文一律通过工具按路径实时读取，不入向量库。

## 4. 迁移与维护任务（已落地）

1. 向量到中央迁移：从 `main_collection` 抽取旧记忆并落中央 SQL。  
2. 记忆向量库同步：按 provider 条件把中央记忆索引缺失项补到 `memory_index`。  
3. 笔记向量库同步：由中央笔记索引维护 `notes_index`（provider 切换全量，否则增量）。  
4. 中央库每日 JSON 冷备份：每天 1 次，最多保留 3 份。

## 5. 运维与备份（已落地）

1. 保留 JSON 冷备份：每天 1 次，最多 3 份。  
2. 备份源仅中央 SQL（不是向量层）。  
3. 向量层可随时丢弃并由 SQL 重建。

## 6. 代码改造清单（完成）

1. `llm_memory/components/memory_sql_manager.py`：中央库主写、ID 强制自生成。  
2. `llm_memory/components/vector_store.py`：轻量索引读写（仅 id/document/embedding）。  
3. `llm_memory/components/memory_sql_manager.py`：统一 `global_tags` 与关系表管理。  
4. `llm_memory/service/memory_manager.py`：改为 ID 回 SQL，不再依赖向量 metadata。  
5. `llm_memory/service/note_service.py`：`note_index_records + note_tag_rel` 主导，扫描不做向量化。  
6. `core/services/sleep_maintenance_service.py`：迁移任务、记忆/笔记向量库同步、每日 JSON 备份任务。  
7. `core/component_factory.py` / `core/plugin_context.py` / `llm_memory/utils/path_manager.py`：统一中央目录路径。

## 7. 下线清单（已执行）

1. 旧私有 tags 命名空间写入。  
2. 任何从向量 metadata 直接构造业务对象的逻辑。  
3. 旧命名与兼容入口。  
4. 旧 NoteData 依赖链（按你已确认的废弃策略）。

## 8. 验收结果口径

1. 相同 tag 名在全系统唯一 tag_id。  
2. 向量层不承载业务字段，检索仍通过“向量 ID -> SQL 回查”完成。  
3. 向量删除后可由 SQL 完整重建。  
4. Simple/Vector 两模式均可用（命中集合允许因向量召回与 tags 召回策略差异而不同）。  
5. 每日 JSON 备份正常产出且最多保留 3 份。

## 9. 归档说明

该子计划已完成，后续演进请新增独立计划文件。
