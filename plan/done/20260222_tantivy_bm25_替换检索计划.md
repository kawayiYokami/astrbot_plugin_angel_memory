# 20260222 Tantivy 新检索引擎重建计划

## 目标
- 彻底废除现有 FTS5 检索链路，重建统一的 Tantivy 检索引擎。
- 引擎统一服务 memory / note 两类检索，不再保留 FTS5 兼容层。
- 支持三档检索策略（统一调度）：
1. 无嵌入、无重排：直接返回 Tantivy Top-K。
2. 有嵌入、无重排：`0.7 * 向量分 + 0.3 * BM25归一分`。
3. 有嵌入、有重排：向量 Top-K 与 BM25 Top-K 合并去重后重排。
- BM25 原始分按最大分归一化到 `[0, 1]`：`normalized = score / max_score`，`max_score=0` 时记为 0。

## 关键原则
- 不再沿用旧检索器接口，不做 FTS5 回退。
- rerank 能力与 `enable_simple_memory` 解耦：只由是否存在可用 `rerank_provider` 决定。
- memory 与 note 使用同一套策略框架，避免行为分裂。
- Tantivy 中文检索采用“Python 侧预分词”方案：`jieba` 负责中文切词，Tantivy 仅负责 BM25 与倒排检索。

## 中文分词方案（新增）
1. 写入侧预分词
- 对 memory（judgment/tags）与 note（tags/路径/标题）文本先做 `jieba` 分词。
- 将 token 用空格拼接后写入 Tantivy 文本字段（`tokenized_text`）。
- 原文仍单独存储（用于重排文本构造与调试）。

2. 查询侧预分词
- 查询词先走同一分词流程，得到 token 列表。
- 用 token 构造查询（避免直接拼原始中文查询字符串）。
- 空查询或无有效 token 时直接返回空结果。

3. 一致性与安全
- 索引/查询使用同一归一化规则（小写、去空白、过滤纯符号 token）。
- 不依赖 Tantivy 原生中文分词能力，避免平台差异。

## 改造范围
- 新增：`llm_memory/components/tantivy_search_engine.py`（统一检索引擎）
- 替换：`llm_memory/components/memory_sql_manager.py`（接入新引擎并删除 FTS5 调度）
- 调整：`llm_memory/service/memory_manager.py`（必要时仅参数透传）
- 调整：`llm_memory/service/memory_handlers.py`（必要时仅参数透传）
- 调整：`llm_memory/service/note_service.py`（走新引擎一致策略）
- 调整：`core/component_factory.py`（Simple 路径也注入 rerank_provider）
- 调整：`core/services/sleep_maintenance_service.py`（移除 FTS5 巡检/修复任务）
- 调整：`_conf_schema.json`（新增检索策略配置）
- 调整：`core/config.py`（读取新配置）
- 调整：`requirements.txt`（加入 Tantivy 依赖）
- 调整：`metadata.yaml`（递增版本）
- 调整：`CHANGELOG.md`（记录检索层重建与行为变化）
- 删除：`llm_memory/components/bm25_retriever.py`（FTS5 检索器）

## 实施步骤
1. 新建统一 Tantivy 引擎
- 提供 memory/note 索引的 `rebuild / upsert / delete / search`。
- 输出统一候选结构：`id`, `bm25_score`, `bm25_normalized_score`。
- 查询前统一 `jieba` 预分词，索引字段与查询字段一一对应。

2. 三档策略在引擎内收敛
- 档1（BM25 only）：直接按 BM25 归一分排序返回。
- 档2（融合）：`final = 0.7 * vector + 0.3 * bm25_norm`。
- 档3（重排）：
  - 分别获取向量 Top-K、BM25 Top-K；
  - 合并去重后构造文档文本；
  - 调用上游 rerank，按 rerank 顺序输出。
- 统一候选放大策略，默认 `candidate_k = limit * multiplier`。

3. MemorySqlManager 对接
- 移除 `_fts_*` 字段与相关方法。
- `recall_by_tags` / `search_note_index_by_tags` 改为调用新引擎。
- 记忆域过滤、阈值过滤继续在 SQL 层执行，保证语义不变。

4. 组件注入调整
- `ComponentFactory` 无论 Simple/Vector 路径都解析 `rerank_provider`。
- 将 `rerank_provider` 注入 `MemorySqlManager`（或新引擎构造参数）。

5. 下线 FTS5 维护链路
- 删除睡眠维护中的 FTS5 巡检/修复任务与日志。
- 清理 FTS5 命名日志，改为 `[检索]` 或新引擎前缀。

6. 配置项
- 新增（示例）：
  - `retrieval.bm25_engine = "tantivy"`
  - `retrieval.memory_vector_weight = 0.7`
  - `retrieval.memory_bm25_weight = 0.3`
  - `retrieval.note_vector_weight = 0.7`
  - `retrieval.note_bm25_weight = 0.3`
  - `retrieval.candidate_multiplier = 6`
  - `retrieval.tokenizer = "jieba_pretokenized"`
- 默认值可直接跑通三档策略，未配置时安全降级到默认参数。

7. 验证
- 自测三档路径：
  - 档1：无向量、无 rerank。
  - 档2：有向量、无 rerank。
  - 档3：有向量、有 rerank。
- 中文检索专项：验证“索引预分词”和“查询预分词”一致生效。
- 回归检查：memory/note 都可返回稳定结果。
- 静态检查：`python -m compileall` 覆盖改动文件。

## 风险与对策
- Tantivy 依赖安装兼容性：
  - 固定可用版本并提供清晰异常日志，安装失败即显式失败，不回退 FTS5。
- 预分词词典差异导致召回波动：
  - 统一词典初始化流程并输出分词统计日志，支持后续调参。
- 行为迁移造成召回变化：
  - 增加策略日志（档位、候选数、融合/重排耗时）便于线上调参与排障。

## 验收标准
- 主流程不再引用 FTS5 检索实现或相关维护任务。
- 三档策略按输入条件正确切换，且符合定义。
- 档2严格使用 `0.7*向量 + 0.3*BM25归一分`。
- 档3严格执行“各自Top-K -> 合并去重 -> rerank”。
- SimpleMemoryRuntime 路径具备 rerank 能力（有 provider 即生效）。
- 中文查询可稳定命中中文索引内容（基于 jieba 预分词）。
- `metadata.yaml` 版本已递增。
## 实际落地与偏离说明（归档）

### 与原计划的主要偏离
- 未新增 `llm_memory/components/tantivy_search_engine.py`，而是直接重构现有 `llm_memory/components/bm25_retriever.py` 为 Tantivy BM25 模块，减少调用层改动。
- 未删除 `bm25_retriever.py`，改为模块语义升级（名称沿用，内部实现更换）。
- 三档策略从 `MemorySqlManager` 中进一步抽离到 `llm_memory/components/hybrid_retrieval_engine.py`，由独立模块统一调度。
- 检索策略由“按 Simple/Vector 路径”调整为“按能力分档”：BM25、向量能力、重排能力独立判定。

### 当前最终实现状态
- BM25 引擎：Tantivy + Python 侧 jieba 预分词（索引/查询同流程）。
- 三档策略：
  1) 无向量无重排 -> BM25 直出；
  2) 有向量无重排 -> 0.7 向量 + 0.3 BM25；
  3) 有重排 -> 候选集合重排（可仅 BM25 候选，也可 BM25+向量合并候选）。
- 重排失败降级：自动降级到无重排策略（有向量降级融合，无向量降级 BM25）。
- 配置层：移除 `enable_simple_memory` 面板入口；引入 `retrieval` 分组，并保留代码级旧字段回退（自然过渡）。

### 测试与验证
- 新增模拟测试：`debug_tool/hybrid_retrieval_engine_sim_test.py`。
- 覆盖：三档主路径 + 重排失败降级路径。
- 本地执行结果：通过。

### 归档结论
- 该计划已完成并在联调过程中迭代收敛，按“当前实现事实”归档。

## 附录：20260221 FTS5 tags 注词增强计划合并说明

> 来源：`plan/20260221_fts5_tags_addword增强计划.md`（已并入并删除原文件）

该计划提出的核心诉求（统一 tags 词表、索引/查询分词一致、启动/重建/查询兜底、并发锁保护与可观测）在后续 Tantivy 重构中已被“中文预分词一致性方案”吸收与延续：
- 保留了 `jieba` 词表注入机制与并发保护思路。
- 保留了索引构建前与查询前的词表就绪保障。
- 保留了分词一致性与可观测日志目标。

差异点：
- 原计划以 FTS5 为落地点；当前已迁移为 Tantivy BM25。
- 原计划中的 FTS5 专项巡检、表结构指标等内容，已转为 Tantivy 语义下的等价能力（不再保留 FTS5 专有术语）。

结论：
- 该计划已被后续检索重构实质吸收，无需单独保留为独立执行计划。
