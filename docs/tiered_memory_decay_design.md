# 分档记忆衰减算法设计与测试记录

## 1. 设计目标

本算法用于在高频反思场景下实现以下目标：

1. 重要记忆可持续累积，不被误删。
2. 低价值记忆高比例自动驱散，避免无效膨胀。
3. 通过少量核心参数控制整体行为，便于快速调参。
4. 满足高压场景：每日反思调用量可达 5000~10000 次。

---

## 2. 档位定义与命名

记忆按 `useful_score` 升档：

- `T0_易逝档`（Tier 0）
- `T1_待证档`（Tier 1）
- `T2_核心档`（Tier 2）

升档阈值：

- `T0 -> T1`: `useful_score >= 3`
- `T1 -> T2`: `useful_score >= 10`

---

## 3. 三档行为规则

### 3.1 T0_易逝档

- 采用时间驱动自然遗忘（按遗忘周期自动 `strength - 1`）。
- 适合快速清理噪声、临时记忆。

### 3.2 T1_待证档

- 不做时间驱动遗忘。
- 仅在「被召回且判定无用」时执行 `strength - 1`。
- 若隔较长时间再次召回并判定有用，可继续强化并升档。

### 3.3 T2_核心档

- 永不遗忘（不受时间与召回无用影响）。
- 作为长期稳定资产池。

---

## 4. 核心参数命名

### 4.1 全局参数

- `forget_speed`：全局遗忘速度倍率（越大忘得越快）
- `consolidate_speed`：巩固速度倍率（越大升档越快）

### 4.2 档位遗忘速度参数

- `tier0_forget_speed`：T0遗忘速度倍率
- `tier1_forget_speed`：T1遗忘速度倍率（当前规则下仅用于兼容，T1不走自然遗忘）
- `tier2_forget_speed`：T2遗忘速度倍率（当前规则下仅用于兼容，T2不遗忘）

### 4.3 基础周期参数

- `cycle_3d`：低档基础遗忘周期（天）
- `cycle_21d`：中档基础遗忘周期（天）
- `cycle_90d`：高档基础遗忘周期（天）

### 4.4 召回/反馈场景参数

- `recall_topk`：单次召回上限
- `useful_prob`：单条被判有用概率
- `daily_calls_min` / `daily_calls_max`：每日反思调用区间
- `useful_boost`：判有用时 `strength` 增量

---

## 5. 算法流程（简化版）

1. 每日产生若干反思调用（`daily_calls_min ~ daily_calls_max`）。
2. 每次调用刷新 1 条新记忆样本。
3. 每次调用召回最多 `recall_topk` 条。
4. 对每条召回结果：
   - 有用：`strength += useful_boost`，`useful_score += consolidate_speed`
   - 无用：
     - T0：不在此处减（由时间驱动处理）
     - T1：`strength -= 1`
     - T2：不减
5. 时间衰减：
   - 仅 T0 生效（按周期扣强度）
6. 删除条件：
   - `strength <= 0` 记忆进入遗忘。

---

## 6. 测试环境与场景

测试工具：`debug_tool/memory_decay_simulator.py`

关键场景分级：

- 模拟时长：1 年
- 单次召回上限：10 条
- 单条有用概率：5%
- 初始记忆数：0

压力等级定义：

- 中压：每日反思调用 `500` 次
- 高压：每日反思调用 `5000` 次
- 极限高压：每日反思调用 `10000` 次

---

## 7. 测试结果记录

### 7.1 基线（巩固速度 1.0）

参数：

- `cycle = 3/21/90`
- `forget_speed = 1.0`
- `consolidate_speed = 1.0`

结果：

- 累计创建：`182500`
- 被遗忘：`173544`（约 95.1% 驱散）
- 年末存活：`8956`
- 分档存活：`tier0=8784, tier1=170, tier2=2`

结论：

- 在 `useful_prob=0.05` 条件下，升到核心档过慢，核心累积不足。

### 7.2 推荐（巩固速度 2.5）

参数：

- `cycle = 3/21/90`
- `forget_speed = 1.0`
- `consolidate_speed = 2.5`

结果：

- 累计创建：`182500`
- 被遗忘：`172705`（约 94.6% 驱散）
- 年末存活：`9795`
- 分档存活：`tier0=8128, tier1=351, tier2=1316`

结论：

- 在高驱散率保持的前提下，核心档显著增长。
- 更符合“重要记忆可积累，垃圾记忆快速消退”的目标。

### 7.3 高压（5000/天，使用推荐参数）

参数：

- `cycle = 3/21/90`
- `forget_speed = 1.0`
- `consolidate_speed = 2.5`

结果：

- 累计创建：`1,825,000`
- 被遗忘：`1,726,534`（约 94.6% 驱散）
- 年末存活：`98,466`
- 分档存活：`tier0=81,612, tier1=3,401, tier2=13,453`

结论：

- 在 5000/天 场景下仍保持约 90%+ 驱散，核心档可持续累积。

### 7.4 极限高压（10000/天，使用推荐参数）

参数：

- `cycle = 3/21/90`
- `forget_speed = 1.0`
- `consolidate_speed = 2.5`

结果：

- 累计创建：`3,650,000`
- 被遗忘：`3,452,890`（约 94.6% 驱散）
- 年末存活：`197,110`
- 分档存活：`tier0=163,308, tier1=6,866, tier2=26,936`

结论：

- 在 10000/天 极限场景下，算法依旧稳定运行并保持高驱散率。
- 核心档数量继续增长，符合“重要记忆积累”目标。

---

## 8. 当前推荐默认配置

- `cycle_3d = 3`
- `cycle_21d = 21`
- `cycle_90d = 90`
- `forget_speed = 1.0`
- `consolidate_speed = 2.5`
- `tier0_forget_speed = 1.0`
- `tier1_forget_speed = 1.0`
- `tier2_forget_speed = 1.0`
- `useful_boost = 1`

---

## 9. 后续建议

1. 将该算法从模拟器迁移到正式记忆运行时。
2. 在 debug tool 中增加参数面板与结果曲线可视化。
3. 上线后记录真实 `useful_prob` 分布，反向校准 `consolidate_speed`。
