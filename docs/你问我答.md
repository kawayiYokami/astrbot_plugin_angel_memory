# Angel Memory 系统设计问答

## 系统整体

### Angel Memory 是什么？

「认知双系统」。模拟人类「潜意识记忆」+「显性知识」的完整认知架构。

- **记忆系统**：处理"我经历了什么"
- **笔记系统**：提供"世界是什么"
- **灵魂系统**：调节"我是什么状态"
- **协同增强**：三系统为主模型提供认知支持

### 为什么需要双系统？

「潜意识」作为sub agent，核心作用是降低主模型tokens和减少误报率。

**问题一：Token浪费**
- 庞大记忆库直接注入主模型消耗巨大
- 大量无用知识污染上下文
- 「潜意识」预筛选，只推送有价值信息

**问题二：信息误报**
- 向量化搜索天然存在误报
- 相似度高不代表真正有用
- 「潜意识」二次验证，过滤干扰信息

**设计理念**：
- 主模型专注推理
- 潜意识管理记忆
- 分工降低认知成本

### 笔记系统的定位是什么？

本地知识补充，不是外部信息同步。

**职责划分**：
- **天使之眼**：从网络获取外部信息
- **Angel Memory**：从本地补充私有知识

**为什么放在这里**：
- 记忆系统已有向量化技术
- 共用底层架构降低成本
- 统一检索接口简化调用

**核心差异**：
- 网络信息是公开的
- 本地知识可人为选择
- 用户主动投喂高质量内容

---

## 记忆系统设计

### 什么是「记忆元」？

记忆的原子单位。每个「记忆元」是完整的认知单元。

**结构**：论断 + 理由 + 标签 + 状态快照

- **论断**：语言化的认知内容
- **理由**：记忆的价值含金量
- **标签**：分类和检索的索引
- **状态快照**：创建时的灵魂状态

### 为什么必须是"论断"？

只有论断才是语言记忆。

人类体验充满感官信息和情绪波动，这些都是瞬间的情景上下文。只有用语言概括成"这是一个XX"的论断时，体验才转化为可存储的记忆。

**核心机制**：
- 从流动到固化：切分连续体验
- 从混沌到有序：赋予结构形式
- 从体验到知识：语言化才可操作

### "理由"有什么用？

理由是记忆的含金量。

论断"这是苹果"如果没有理由支撑，就像没有根的浮萍。理由回答"为什么这个论断重要"，将新论断与已有知识体系连接。

**价值体现**：
- **记忆粘合剂**：锚定在知识体系中
- **理解标志**：能给理由意味着真正理解
- **优先级度量**：理由质量决定记忆寿命

### 为什么有五种记忆类型？

模拟人类记忆的多维结构。

| 类型 | 存储内容 | 判断标准 |
|-----|---------|---------|
| **知识元** | "是什么"的事实 | 可验证真伪的陈述 |
| **技能元** | "怎么做"的方法 | 包含步骤和理由 |
| **情感元** | "感觉怎样"的体验 | 有客观证据支撑 |
| **任务元** | "在做什么"的当前状态 | 实际执行的动作 |
| **事件元** | "他者做了什么"的外部行为 | 非AI主体的事件 |

**设计理念**：不同类型记忆有独立通道，互不干扰。

### 什么是"认知循环"？

记忆系统的自主工作流程。

**观察 → 回忆 → 反馈 → 睡眠**

- **观察**：从对话提炼值得记录的体验
- **回忆**：检索相关记忆提供给主意识
- **反馈**：从对话验证记忆价值
- **睡眠**：后台优化记忆网络

**自主性**：无需主意识指令，潜意识自行判断和运行。

### 什么是"链式回忆"？

模拟人类联想思考的检索机制。

**流程**：

1. **解析秘书决策**：从`angelheart_context`提取topic、entities、facts、keywords
2. **双轨并行检索**：记忆通道 + 笔记通道同时工作
3. **灵魂共鸣**：旧记忆状态快照影响当前状态
4. **动态限制**：`RecallDepth`控制检索数量上限

**设计目标**：
- 避免单一类型霸占
- 保持认知多样性
- 模拟直觉涌现

### 记忆如何优化？

通过反馈和睡眠动态调整。

**反馈机制**：
- **有用记忆**：增加`useful_score`，可能升档
- **重复记忆**：合并精炼，继承权重
- **新生记忆**：建立关联，加入网络

**三档分级遗忘**：
- **T0易逝档**：`useful_score < 3`，自然衰减，年驱散率~95%
- **T1待证档**：`3 ≤ useful_score < 10`，被召回且无用时衰减，年驱散率~60%
- **T2核心档**：`useful_score ≥ 10`，永不遗忘，年驱散率~20%

**睡眠优化**：
- 前置维护：向量同步
- 记忆巩固：衰减清理
- 后置维护：迁移备份

### 短期记忆和长期记忆如何工作？

「短期记忆」是先进先出的记忆巢位，「长期记忆」是永久存储的网络。

**短期记忆机制**：
- 固定容量的记忆槽位
- 新记忆进入，最老记忆退出
- 保证AI永远持有最近的信息

**核心价值**：
- 底层向量检索容易随机召回无关记忆
- 短期记忆巢位确保最近信息始终在场
- 高质量的"灵光一闪"长期维持在主意识中

**长期记忆机制**：
- 通过反馈机制筛选进入
- 高权重记忆长期保存
- 按需召回，不常驻内存

**协同工作**：
- 短期记忆：保证新鲜度
- 长期记忆：保证深度和广度
- 双层结构：平衡性能和完整性

---

## 灵魂系统设计

### 什么是灵魂系统？

四维能量槽 + 橡皮筋算法，模拟人类的"情绪惯性"和"创伤应激"。

**四维能量槽**：

| 维度 | 作用 | 默认值 | 范围 |
|------|------|--------|------|
| RecallDepth | 检索数量上限 | 7 | 1-20 |
| ImpressionDepth | 新记忆生成上限 | 3 | 1-10 |
| ExpressionDesire | 发言长度倾向 | 0.5 | 0-1 |
| Creativity | 思维发散倾向 | 0.7 | 0-1 |

### 为什么需要灵魂系统？

让AI拥有"性格"和"状态"，而不是永远一致的回复。

**核心特性**：
- **弹性系统**：能量值倾向回归mid，离mid越远越难继续偏离
- **双轨调整**：主动反思（强度1.0）+ 被动共鸣（强度0.3）
- **原子化接口**：所有调整都通过4位二进制代码统一处理

### 什么是橡皮筋算法？

将无界的能量值映射到有界的物理参数区间。

**公式**：
```
y = mid + (max - mid) * tanh(k * x)  if x >= 0
y = mid + (mid - min) * tanh(k * x)  if x < 0
```

**效果**：
- 能量值倾向回归mid（默认值）
- 离mid越远越难继续偏离（弹性阻力）
- 防止极端状态持续太久

### 什么是灵魂共鸣？

旧记忆状态影响当前状态的机制。

**工作流程**：
1. 检索到的记忆携带`state_snapshot`（创建时的灵魂状态快照）
2. 当前灵魂状态与旧记忆快照产生共鸣
3. 共鸣会微调当前状态，产生"情绪惯性"

**效果**：
- 回忆开心事 → 状态偏向开心
- 回忆悲伤事 → 状态偏向悲伤
- 模拟人类的"情绪惯性"

### 什么是灵魂反思？

对话后主动调整状态的机制。

**工作流程**：
1. 主LLM回复后，小模型分析对话
2. 输出4位状态代码（如`1011`）
3. 每一位对应一个维度的增减方向
4. 使用`adjust(code, mode="reflect")`原子化调整

**代码含义**：
- `0000`：颓废（话少、死板、不查历史、拒绝新知）
- `1111`：觉醒（话多、飞升、查阅历史、吸收新知）

---

## 笔记系统设计

### 笔记系统的核心是什么？

中央SQL索引 + tags向量索引，不再全量向量化。

**架构变化**：
- **旧方案**：正文全量向量化，存储体积大
- **新方案**：tags索引 + 轻量向量索引，效率提升

**职责分工**：
- **中央SQL索引**：唯一真相源，存储所有元数据
- **notes_index向量库**：检索缓存，仅索引tags

### 为什么要用tags索引替代全量向量化？

效率、体积、精度的三重提升。

**效率提升**：
- 大规模笔记场景索引效率显著提升
- 数万条可在十几秒级完成索引

**体积下降**：
- 不再存储正文向量
- 存储体积明显下降

**精度保障**：
- tags提供精确匹配锚点
- 向量检索提供语义匹配

### 什么是叶子节点索引？

仅为"没有子标题"的标题节点建索引。

**分块原则**：
- 按H1/H2/H3标题划分
- 仅为叶子节点（无子标题）建索引
- 避免冗余，提升检索精度

**示例**：
```markdown
# 武器
## 法器
### 乌髓孑灯
武器故事内容...  ← 建索引

### 另一把武器
其他内容...      ← 建索引
```

### 标签从哪里来？

多层级自动提取。

| 权重 | 来源 | 示例 |
|-----|------|------|
| 最高 | 文件名+路径 | `武器/法器/乌髓孑灯.md` |
| 高 | 标题结构 | `# 草史莱姆 ## 攻击方式` |
| 中高 | 专有名词 | `"盗亦有道"` `《原神》` |
| 中 | 加粗文本 | `**元素属性**: 草` |
| 基础 | 正文关键词 | 常规词汇 |

**设计理念**：
- 路径即分类：目录结构携带层级信息
- 标题即上下文：避免内容重叠污染
- 专有名词即锚点：高价值检索词

### 如何保证检索的准确性？

三层保障：tags索引 + 向量检索 + 阈值过滤。

**第一层：tags索引**
- 精确匹配锚点
- 路径+标题提供完整上下文

**第二层：向量检索**
- 向量语义相似度匹配
- 快速获取候选集

**第三层：阈值过滤**
- 相似度阈值0.5
- 过滤低质量结果

**容错机制**：
- Top-K返回多个候选
- 主模型最终判断相关性
- 宁可召回多不可遗漏少

### 怎么解决片段信息丢失问题？

标签链即完整上下文。

**问题背景**：
- 文档按标题切分成独立片段
- 每个片段只包含局部内容
- 缺少前后文导致理解困难

**我们的方案：标签链重建**

每个片段携带完整的标签层级链：
```
片段内容：武器故事的具体描述...

标签链：
[武器] → [法器] → [乌髓孑灯] → [武器故事]
```

**成本对比**：
```
传统重建：
片段150字 + 前文500字 + 后文500字 = 1150字

标签链重建：
片段150字 + 标签链20字 = 170字
```

---

## 核心架构

### 什么是中央索引真相源？

中央SQL索引是唯一真相源，向量库收敛为检索缓存。

**设计原则**：
- 中央SQL索引：唯一真相源
- 向量库：检索缓存，不承载主数据语义
- 支持无向量模式（SimpleMemoryRuntime）

**优势**：
- 数据一致性有保障
- 存储体积明显下降
- 支持无向量模式下的可用检索路径

### 服务如何拆分？

DeepMind职责拆分为多个独立服务：

| 服务 | 职责 |
|------|------|
| `RetrievalService` | 记忆/笔记检索、上下文解析 |
| `InjectionService` | 记忆/笔记/灵魂状态注入到请求 |
| `FeedbackService` | 异步反馈分析、记忆更新 |
| `SleepService` | 睡眠调度、维护管线编排 |
| `SleepMaintenanceService` | 具体维护任务执行 |

**设计理念**：单一职责，便于测试和维护。

### 睡眠维护管线是什么？

三阶段维护流程：前置维护 → 记忆巩固 → 后置维护

**前置维护（pre_consolidate）**：
- 向量到中央迁移：确保向量库数据回灌到中央SQL
- 记忆向量同步：同步中央SQL到向量索引

**记忆巩固（consolidate_memories）**：
- 执行三档分级衰减算法
- 清理过期记忆
- 合并相似记忆

**后置维护（post_consolidate）**：
- memory_scope补齐迁移
- 废弃字段清理
- 笔记向量库同步（增量/全量重建）
- 每日JSON备份（保留最近3份）

---

## 核心设计哲学

### 为什么模拟儿童认知？

儿童学习揭示知识形成的根本机制。

**三步渐进**：
1. **"这是什么？"** → 命名认知，形成论断
2. **"为什么？"** → 权威确认，建立理由
3. **"为什么是这个？"** → 特征理解，生成标签

**AI映射**：
- 观察阶段：提炼论断
- 理解阶段：挖掘理由
- 分类阶段：标注标签

**本质意义**：
- 触及知识形成根本规律
- AI首次拥有类人类认知基础
- 从模拟到本质的跃迁

### 记忆和笔记如何协同？

经验智能 + 知识支持 = 完整认知。

**记忆系统贡献**：
- 对话经验的积累
- 用户偏好的学习
- 情感社交的理解

**笔记系统贡献**：
- 外部知识的扩展
- 专业领域的深度
- 客观事实的支持

**协同效应**：
- 经验指导知识筛选
- 知识验证经验价值
- 双系统互补增强

### 为什么是"潜意识"设计？

主意识专注推理，潜意识管理记忆。

**人类认知特征**：
- 显意识处理当前任务（高能耗）
- 潜意识处理记忆情感（低能耗）
- 分工合作效率最高

**AI架构映射**：
- 主模型专注对话推理
- 记忆系统自主运行
- 无需指令，自然涌现

**价值实现**：
- 专注力解放
- 效率提升
- 认知完整

---

## 使用场景

### 适合什么应用场景？

需要长期记忆和知识扩展的对话场景。

**个人助理**：
- 记住用户偏好和习惯
- 学习用户工作方式
- 提供个性化服务

**专业顾问**：
- 接入专业知识库
- 提供领域深度回答
- 经验积累优化建议

**社交陪伴**：
- 记住对话历史
- 理解情感和关系
- 构建长期连接

### 如何使用记忆系统？

设置提供商，然后无脑启用。

**配置提供商**：
1. 在配置中设置`provider_id`
2. 指定API提供商ID
3. 记忆系统将使用该提供商的嵌入能力

**不设置提供商**：
- 自动启用本地嵌入模型
- 模型：`BAAI/bge-small-zh-v1.5`
- **仅支持中文**，不支持其他语言
- 首次使用会自动下载模型

**启动后**：
- 记忆系统自动运行
- 无需手动操作
- 自主观察、回忆、反馈、睡眠

### 如何使用笔记系统？

整理资料，放入指定目录。

**步骤一：找到目录**
```
astrbot\data\plugin_data\astrbot_plugin_angel_memory\raw
```

**步骤二：整理资料**
- 使用Markdown格式
- 精心组织内容结构
- 建议用AI辅助整理

**步骤三：分类存放**
- 目录结构即分类体系
- 分类越清晰，检索效率越高

**步骤四：重启插件**
- 触发自动扫描
- 解析并建索引
- 建立索引

**后续更新**：
- 添加、修改、删除文件
- 重启插件即可同步
- 增量更新，无需全量重建

---

## 与其他系统的区别

### 这是一个什么级别的系统？

生产级的AI认知系统，不是技术Demo。

**理论创新**：
- 双系统认知架构
- 记忆元原子单位
- 链式回忆机制
- 三档分级遗忘
- 灵魂状态系统

**工程完备**：
- 中央索引真相源
- 容错降级策略
- 性能监控体系
- 睡眠维护管线

**实战导向**：
- API消耗降至1%
- 50万配额长期使用
- 稳定可靠部署

### 与其他记忆系统的区别？

从存储到认知的本质跃迁。

| 维度 | 传统方案 | Angel Memory |
|-----|---------|--------------|
| **记忆模型** | 对话历史 | 认知循环+类型化记忆元 |
| **知识库** | 静态向量库 | 中央索引+tags索引 |
| **遗忘机制** | 无/简单过期 | 三档分级遗忘 |
| **状态系统** | 无 | 灵魂四维能量槽 |
| **性能** | 单条调用 | 三层缓存(99%↓) |
| **容错** | 硬失败 | 降级策略+静默恢复 |
| **哲学** | 信息存储 | 认知构建 |

**核心差异**：我们不是在存储信息，而是在构建认知。

### 终极目标是什么？

构建既有思想又有知识的AI大脑。

**思想**：来自记忆系统的经验积累
- 从对话中学习
- 认知网络自我进化
- 类人类的理解能力

**知识**：来自笔记系统的外部智库
- 突破训练数据边界
- 专业领域深度扩展
- 本地知识人为筛选

**智能**：来自双系统协同的完整认知
- 经验+知识=完整智能
- 从模拟到本质
- 重新定义AI认知

---

**论断驱动，记忆友好。**
