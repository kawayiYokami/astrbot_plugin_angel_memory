# 桌面端迁移：多层索引与中央记忆库架构说明

## 1. 文档目的
- 说明当前项目的“数据真相源 + 检索加速层”架构。
- 给桌面端迁移提供统一认知：先落地中央记忆库，再按阶段接入多层索引。
- 本文聚焦架构与数据流，不讨论具体代码实现细节。

## 2. 核心结论（一句话）
- **中央 SQL 记忆库是唯一真相源**；FTS5 和向量层都是检索加速层，可重建、可替换、可降级。

## 3. 术语与分层

### 3.1 真相层（Authority Layer）
- 中央 SQL 库（记忆、笔记元数据、标签关系、范围/时间等业务字段）。
- 职责：持久化、可审计、可迁移、可备份。
- 要求：任何业务写入先进入真相层。

### 3.2 稀疏检索层（Sparse Layer）
- FTS5 索引（记忆与笔记两套独立索引，物理分表）。
- 职责：关键词/标签驱动召回，作为默认高性价比检索路径。
- 特点：可由中央 SQL 全量或增量重建。

### 3.3 稠密检索层（Dense Layer，可选）
- 向量索引（用于语义相似度补充，不承担业务真相）。
- 职责：语义召回与排序增强。
- 特点：缺失时系统应可降级运行，不影响数据正确性。

## 4. 记忆库方案（Memory Store Strategy）

### 4.1 数据主线
1. 写入：主流程将记忆写入中央 SQL。
2. 检索：优先走 FTS5 召回，按需要融合向量分。
3. 维护：睡眠/巡检任务保证“中央 SQL 与索引层”一致性。
4. 备份：中央 SQL 为主备份对象，索引层可随时重建。

### 4.2 为什么这样设计
- 避免把向量库当业务主库，降低迁移风险。
- 能在“无向量模型”环境下稳定运行。
- 便于跨端（服务端/桌面端）统一数据语义。

## 5. 多层索引方案（Multi-Index Strategy）

### 5.1 记忆与笔记分索引
- 记忆索引：面向短文本记忆单元（重点 tags + judgment）。
- 笔记索引：面向结构化知识条目（当前主策略为 tags 检索，不索引正文）。
- 设计原则：**同算法、分索引、分阈值**，避免互相污染。

### 5.2 统一融合框架
- 统一评分框架：`final = fts_weight * fts_score + vector_weight * vector_score`。
- 允许记忆与笔记使用不同权重与阈值。
- 向量不可用时，系统可使用降级策略（例如默认分或纯 FTS 路径），但必须可观测。

### 5.3 一致性保障
- 启动阶段：索引预构建。
- 运行阶段：增量同步优先，必要时全量重建。
- 巡检阶段：校验 SQL 与索引条目一致性，异常自动修复。

## 6. 两种部署模式（迁移最关键）

### 6.1 模式 A：仅中央记忆库（桌面端当前状态）
- 组成：中央 SQL + FTS5。
- 不启用：向量化、向量索引同步。
- 目标：先跑通“可用、稳定、可维护”的记忆系统。
- 检索行为：以 FTS5 为主，满足绝大多数结构化/标签化召回需求。

### 6.2 模式 B：完整多层索引（服务端成熟状态）
- 组成：中央 SQL + FTS5 + 向量层。
- 目标：在模式 A 稳定后增加语义召回能力。
- 检索行为：FTS 与向量融合，提升语义泛化与长尾命中率。

## 7. 桌面端迁移建议（按阶段）

### 阶段 1：先统一真相层
- 确保桌面端把中央 SQL 定义为唯一真相源。
- 确保写入链路不绕过中央 SQL。
- 建立基础备份与恢复流程（仅针对中央 SQL）。

### 阶段 2：接入稀疏检索层
- 落地 FTS5 两套索引（记忆/笔记分离）。
- 建立启动预构建、增量更新、巡检修复机制。
- 验证无向量情况下的召回质量与响应延迟。

### 阶段 3：可选接入向量层
- 在不改变真相层语义的前提下增加向量加速层。
- 先灰度融合，再逐步调权。
- 保留“关闭向量即回落到模式 A”的能力。

## 8. 桌面端改造时必须坚持的边界
- 不允许把向量层作为业务主库。
- 不允许记忆和笔记共用一张混合索引表。
- 不允许检索策略与可观测性脱节（必须能解释“为何命中/未命中”）。

## 9. 可观测与验收（迁移完成判定）

### 9.1 必备指标
- 召回命中率（按记忆/笔记分开统计）。
- Top-K 命中率与平均延迟。
- SQL 条目数与 FTS 条目数一致性。
- 索引重建耗时与失败率。

### 9.2 无向量模式验收标准
- 关闭向量后系统仍可稳定检索。
- FTS5 召回结果可解释、可复现。
- 数据恢复仅依赖中央 SQL 即可完成。

## 10. 给后续目录切换的迁移提示
- 切换到桌面端目录后，优先确认三件事：
1. 是否已存在中央 SQL 真相层，以及字段语义是否完整。
2. 是否已实现记忆/笔记分离索引，而不是单表混检索。
3. 是否把向量层定义为“可选增强”而非“必需依赖”。

- 若桌面端当前仅中央记忆库：
1. 先补 FTS5（模式 A）。
2. 再评估是否引入向量层（模式 B）。
3. 全程保持“可降级、可重建、可回滚”。

## 11. 关键数据模型（迁移对齐基线）

### 11.1 MemoryRecord（中央记忆主表）
- `id`：记忆主键（全局唯一）。
- `memory_type`：记忆类型（如偏好/知识/事件等）。
- `judgment`：可检索核心论断。
- `reasoning`：背景解释（不作为主要检索权重）。
- `strength`：记忆强度。
- `is_active`：是否主动记忆（长期保留）。
- `memory_scope`：记忆作用域（如 public/私域分类）。
- `created_at`、`updated_at`：时间戳。
- 可选衰减字段：`useful_count`、`useful_score`、`last_recalled_at`、`last_decay_at`。

### 11.2 GlobalTag（全局标签表）
- `id`：标签 ID。
- `name`：标签名（全局唯一）。

### 11.3 MemoryTagRel（记忆-标签关系表）
- `memory_id`：关联 `MemoryRecord.id`。
- `tag_id`：关联 `GlobalTag.id`。
- 约束：`(memory_id, tag_id)` 唯一。

### 11.4 NoteIndexRecord（笔记索引主表）
- `source_id`：笔记片段主键。
- `note_short_id`：短整型 ID（用于工具/前端交互）。
- `file_id`：文件标识。
- `source_file_path`：源文件相对路径。
- `heading_h1 ~ heading_h6`：层级标题信息。
- `total_lines`：总行数。
- `updated_at`：更新时间。

### 11.5 NoteTagRel（笔记-标签关系表）
- `source_id`：关联 `NoteIndexRecord.source_id`。
- `tag_id`：关联 `GlobalTag.id`。
- 约束：`(source_id, tag_id)` 唯一。

### 11.6 FTS 索引表（加速层，非真相源）
- `memory_fts(item_id, tags, judgment)`：记忆检索索引。
- `note_fts(item_id, tags)`：笔记检索索引。
- 原则：索引可丢失后重建，不承载业务权威字段。

## 12. 遗忘算法（实现机制与关键参数）

### 12.1 算法目标
- 让记忆“可成长也可遗忘”，避免长期无限膨胀。
- 用统一分层规则平衡：新记忆淘汰速度、有效记忆保留能力、核心记忆稳定性。

### 12.2 三档分层规则（按 `useful_score`）
- **T0（易逝档）**：`useful_score < tier0_threshold`
- **T1（待证档）**：`tier0_threshold <= useful_score < tier1_threshold`
- **T2（核心档）**：`useful_score >= tier1_threshold`

### 12.3 行为机制（当前实现）
- 记忆被判定“有用”时：
1. `useful_count += 1`
2. `useful_score += consolidate_speed`
3. 更新 `last_recalled_at`

- 记忆“被召回但无用”时：
1. 仅对 **T1** 执行衰减
2. `strength -= 1`（下限 0）

- 自然遗忘（时间驱动）：
1. 仅对 **T0** 执行
2. 按周期扣减 `strength`
3. 周期计算：`effective_cycle_days = round(cycle_tier0_days / (forget_speed * tier0_forget_speed))`，最小为 1 天

- 核心记忆（T2）：
1. 不参与自然遗忘
2. 不因“召回无用”衰减

### 12.4 默认参数（当前代码默认值）
- `tier0_threshold = 3.0`
- `tier1_threshold = 10.0`
- `consolidate_speed = 2.5`
- `cycle_tier0_days = 3`
- `forget_speed = 1.0`
- `tier0_forget_speed = 1.0`

### 12.5 参数覆盖入口（配置）
- 路径：`memory_behavior.decay_policy_override`
- 开关：`enabled=true` 时才启用自定义参数覆盖
- 保护规则：
1. `tier1_threshold < tier0_threshold` 时自动拉齐为 `tier0_threshold`
2. 速度与周期参数均有最小保护值，避免出现 0 或负值导致异常

### 12.6 与桌面端迁移的关系
- 桌面端即使暂不启用向量化，也应保留该遗忘模型字段与流程（属于真相层业务语义）。
- 先在中央 SQL 落地分层与衰减，再决定是否接入向量层，不会影响遗忘语义一致性。

---

本说明可作为跨端统一架构基线：  
**先真相层，后加速层；先可用稳定，后语义增强。**
