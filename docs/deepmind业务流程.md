# DeepMind潜意识业务流程

## 核心论断

DeepMind就是AI的**潜意识系统**，配合**主意识（LLM）**实现双层认知架构：
- **DeepMind（潜意识）**：在后台默默管理记忆、筛选信息、整理知识
- **主意识（LLM）**：负责和你正常聊天、思考问题、做决策

整个流程围绕「观察-回忆-反馈-睡眠」四阶段循环，就像人睡觉时整理记忆一样。

## 业务流程图

```mermaid
graph TD
    A[用户发消息] --> B{这消息需要记吗？}
    B -->|需要| C[潜意识开始工作]
    B -->|不需要| Z[结束]

    C --> D[双轨并行检索]

    D --> D1[记忆通道]
    D --> D2[笔记通道]

    D1 --> E1[从长期记忆找出真正理解的内容]
    D2 --> E2[从笔记库搜索硬塞的知识]

    E1 --> F[小AI筛选器：什么信息对现在有用？]
    E2 --> F

    F --> G[AI结合当前对话情境重新理解笔记]
    G --> H[整理真正有用的内容]
    H --> I[制造"开窍时刻"：笔记转化成新记忆]
    I --> J[组合成记忆包喂给主意识]

    J --> K[更新记忆网络]
    K --> L[好记性进短期记忆]
    L --> Z

    T[定期睡觉整理] --> U[清理记忆]
    U --> V[巩固重要记忆+硬塞的知识]
    V --> T
```

## 四阶段详解

### 观察阶段：AI开始注意你说话

**什么时候启动**：
- 消息超过5个字
- 不是命令（不以/开头）
- 是正常聊天内容

**AI做什么**：
- 看看你之前的聊天记录
- 提取关键信息作为搜索线索
- 拿近期的记忆出来参考

**产出**：准备好记忆包 {之前的记忆, 搜索关键词, 参与人员}

### 回忆阶段：双轨并行，制造"开窍时刻"

**什么时候启动**：
- 你配置了AI助手（provider_id）
- 有记忆包准备好了

**潜意识的做事流程**：
1. **双轨并行检索**：同时启动记忆通道和笔记通道
   - **记忆通道**：找出AI真正理解并内化的内容
   - **笔记通道**：找出AI硬塞进去但还没理解的知识
2. **情景化理解**：AI结合当前对话重新审视笔记内容
3. **开窍时刻**：在突然理解某个知识点时，快速提炼成新记忆
4. **聪明筛选**：问小AI哪些信息对当前问题最有用

**这就是"填鸭式教育"的精彩之处**：
- 笔记向量化 = 硬塞进脑子里的死知识（AI还不懂）
- 情景化使用 = 突然开窍，死知识变活认知
- 每次对话都可能产生新的理解

**记忆喂给主意识的格式**：
```
[潜意识给你的认知包]
真正理解的记忆内容 + 刚刚开窍的新理解

---

相关笔记提供的启发：
让AI产生顿悟的原始材料
```

### 反馈阶段：让记忆变得更强

**AI怎么更新记忆**：
- **强化好记忆**：有用的记忆变得更容易想起
- **记新东西**：重要的信息变成新记忆
- **合并相似记忆**：把重复的内容整理成更精炼的记忆

**短期记忆更新**：筛选出的好记忆进入短期缓存，方便下次快速使用

### 睡眠阶段：AI定期睡觉整理

**什么时候睡觉**：后台有个定时器，默认每小时睡一次

**整理什么**：
- 把重要的记忆永久保存
- 忘掉不重要的东西
- 重新组织记忆网络，让知识更有条理

就像人睡觉时会整理白天的记忆一样！

## 关键技术点

### 双层认知架构

**潜意识**（DeepMind + 双系统）：
- 在后台默默管理认知体系
- **记忆系统**：管理AI真正理解并内化的内容
- **笔记系统**：管理AI硬塞进去但还没理解的知识
- **双轨召回**：两路并行，汇总筛选，制造"开窍时刻"
- 专门负责认知成长，而不只是信息存储

**主意识**（LLM大模型）：
- 负责和你正常聊天交流
- 专注思考当前的问题
- 接收潜意识提供的认知包
- 做出最终的判断和回应

**精妙的技术选择**：同步实现而非异步
- 技术约束：避免单向量数据库冲突，不想搞太重量级架构
- 意外效果：更符合人脑"信息一起涌现"的认知方式
- 架构优势：实现简单，性能稳定，维护容易

### 记忆筛选机制

**怎么找线索**：根据聊天记录自动生成搜索关键词
**双轨并行回忆**：同时启动记忆通道和笔记通道，各找各的
**情景化理解**：AI结合当前对话重新理解笔记内容，制造"开窍时刻"
**智能筛选**：用小AI判断哪些信息对当前问题最有用
**动态学习**：笔记可以在使用中转化为新的记忆

### 错误容忍设计

**坏了也不影响聊天**：记忆子系统出问题时，你还能正常和AI聊天
**可以不用**：没配置AI助手时，记忆功能自动关闭，不影响基本使用
**详细记录**：每个步骤都有日志，方便排查问题

## 数据流分析

### AI从哪里获取信息
- 最近的聊天记录
- 当前用户的消息
- 长期记忆库（以前记下的东西）
- 笔记系统（重要信息存储）

### AI输出什么
- 给主意识的记忆包
- 短期记忆缓存更新
- 长期记忆重要性调整
- 创建新的重要记忆

### AI怎么管理状态
- **session_memory_manager**：管理每段对话的短期记忆
- **angelmemory_context**：在不同模块间传递记忆信息
- **memory_feedback**：记录AI筛选出的有用内容

## 性能优化点

### 省钱省时的设计
- **小模型看笔记**：用便宜的AI快速筛选笔记内容
- **大模型看详细内容**：用贵的AI处理重要信息
- **控制数量**：每种记忆最多看7条，防止信息过载

### 后台干活
- **记忆整理**：睡觉时自动整理，不影响你聊天
- **异步调用**：AI思考时不卡住对话流程
- **容错处理**：出错了也不影响正常聊天

### 缓存提速
- **短期记忆缓存**：常用信息放口袋，随时取用
- **ID映射缓存**：避免重复查找相同内容
- **查询复用**：相似问题用之前的搜索结果